"use strict";angular.module("d3AngularDemosApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/line",{templateUrl:"views/Line.html",controller:"LineChartCtrl"}).when("/bar",{templateUrl:"views/Bar.html",controller:"BarChartCtrl"}).when("/donut",{templateUrl:"views/Donut.html",controller:"DonutChartCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("d3AngularDemosApp").controller("NavCtrl",["$scope",function(a){a.$on("tabChange",function(b,c){a.currentTab=c})}]),angular.module("d3AngularDemosApp").controller("BarChartCtrl",["$scope","$rootScope","DataSvc",function(a,b,c){a.ui={},a.refresh=function(){a.ui.topRepos=[],c.getTopRepos().then(function(b){a.ui.topRepos=b})},a.refresh(),b.$broadcast("tabChange","bar")}]),angular.module("d3AngularDemosApp").controller("LineChartCtrl",["$scope","$rootScope","$window","DataSvc",function(a,b,c,d){a.refresh=function(){a.stockData=[],d.getStockData().then(function(b){a.stockData=b})},a.refresh(),b.$broadcast("tabChange","line")}]),angular.module("d3AngularDemosApp").controller("DonutChartCtrl",["$scope","$rootScope","DataSvc",function(a,b,c){a.refresh=function(){a.pieData=c.getRandomPieData()},a.refresh(),b.$broadcast("tabChange","donut")}]),angular.module("d3AngularDemosApp").controller("MainCtrl",["$scope","$rootScope",function(a,b){a.replay=function(){a.count++},a.count=1,b.$broadcast("tabChange","home")}]),angular.module("d3AngularDemosApp").directive("barchart",function(){var a=function(a,b){function c(a){v&&clearTimeout(v);var b=l.select(".custom-tooltip"),c=n(a.lang),d=m(a.value)-35;c+t>i&&(c=n(a.lang)-t+n.rangeBand());var e={transform:"translate("+[c,d]+")"};"visible"===b.style("visibility")?b.transition().duration(300).attr(e):b.attr(e),b.select("text").text("Repos: "+d3.format(",")(a.value)),b.style("visibility","visible")}function d(){v=setTimeout(function(){l.select(".custom-tooltip").style("visibility","hidden")},1e3)}var e=b[0],f={top:20,right:10,bottom:80,left:45},g=e.clientWidth,h=e.clientHeight,i=g-f.right-f.left,j=h-f.top-f.bottom,k="#4B7BA3",l=d3.select(e).append("svg").attr("width",g).attr("height",h).append("g").attr("transform","translate("+f.left+","+f.top+")"),m=d3.scale.linear().range([j,0]),n=d3.scale.ordinal().rangeRoundBands([0,i],.1),o=d3.svg.axis().orient("bottom").tickPadding(10),p=d3.svg.axis().orient("left").tickPadding(10).tickFormat(d3.format("s")),q=l.append("g").attr("class","axis").attr("transform","translate("+[0,j]+")"),r=l.append("g").attr("class","axis"),s=l.append("g").attr("class","custom-tooltip"),t=100,u=30;s.append("rect").attr("height",u).attr("width",t),s.append("text").attr("x",10).attr("y",20);var v;a.render=function(b){var e=a.x,f=a.y,g=d3.max(b,function(a){return a[f]}),h=Math.round(.05*g);m.domain([0,g+h]),n.domain(b.map(function(a){return a[e]})),o.scale(n),p.scale(m),q.call(o).selectAll("text").style("text-anchor","end").attr("dx","-10px").attr("dy","-11px").attr("transform","rotate(-90)"),r.call(p);var i=l.selectAll("rect.datum").data(b);i.enter().insert("rect",":first-child").attr("x",function(a){return n(a[e])}).attr("y",j).attr("height",0).attr("width",n.rangeBand()).attr("fill",k).attr("class","datum").on("mouseover",c).on("mouseout",d),i.transition().duration(1200).attr("y",function(a){return m(a[f])}).attr("height",function(a){return j-m(a[f])}),i.exit().remove()},window.onresize=function(){a.$apply()},a.resize=function(){var b=a.x;i=e.clientWidth-f.right-f.left;var c=d3.select(e).select("svg");c.attr("width",i+f.left+f.right),n.rangeRoundBands([0,i],.1),o.scale(n),q.call(o).selectAll("text").style("text-anchor","end").attr("dx","-10px").attr("dy","-11px").attr("transform","rotate(-90)"),c.selectAll("rect.datum").attr("x",function(a){return n(a[b])}).attr("width",n.rangeBand())},a.$watch(function(){return e.clientWidth},function(){a.resize()}),a.$watch("data",function(b){var c=angular.copy(b);a.render(c)},!0)};return{template:"<div></div>",restrict:"EA",replace:!0,scope:{data:"=",x:"@",y:"@"},link:a}}),angular.module("d3AngularDemosApp").directive("linechart",function(){var a=function(a,b){function c(){j=f.clientWidth-g.right-g.left;var a=d3.select(f).select("svg");a.attr("width",j+g.left+g.right),m.range([0,j]),o.scale(m),q.call(o),s.x(function(a){return m(a.date)});var b=a.selectAll("path.line").attr("d",s);if(null!==b.node()){var c=b.node().getTotalLength();b.attr("stroke-dasharray",c+" "+c).attr("stroke-dashoffset",0)}}function d(){var b=d3.mouse(this),c=m.invert(d3.mouse(this)[0]),d=x(a.data,c,1),f=a.data[d-1],g=a.data[d];if(f&&g){var h=c-f.date>g.date-c?g:f,i=b[0],j=n(h.close),o=l.select(".linechart-tooltip");o.select("line").attr("x1",i).attr("y1",k).attr("x2",i).attr("y2",0),o.select(".inner-circle").attr("cx",i).attr("cy",j),o.select(".outer-circle").attr("cx",i).attr("cy",j);var p=e({x:i,y:j});o.select("rect").attr({x:p.x,y:p.y});var q=o.select("text");q.selectAll("tspan").remove(),q.attr("x",p.x+10).attr("y",p.y+15),q.append("tspan").attr("text-anchor","start").text(d3.time.format("%a, %b %d %Y")(h.date)),q.append("tspan").attr("dy",16).attr("dx",-96).attr("text-anchor","start").text("Price: "+z(h.close)),o.style("visibility","visible")}}function e(a){return a.x+Math.round(v/2)>j?{x:a.x-v-20,y:a.y-Math.round(w/2)}:a.y-w<0?{x:a.x-Math.round(v/2),y:a.y+Math.round(w/2)}:a.x-Math.round(v/2)<0?{x:a.x+20,y:a.y-Math.round(w/2)}:{x:a.x-Math.round(v/2),y:a.y-w-20}}var f=b[0],g={top:20,right:10,bottom:80,left:45},h=f.clientWidth,i=f.clientHeight,j=h-g.right-g.left,k=i-g.top-g.bottom,l=d3.select(f).append("svg").attr("width",h).attr("height",i).append("g").attr("transform","translate("+g.left+","+g.top+")"),m=d3.time.scale().range([0,j]),n=d3.scale.linear().range([k,0]),o=d3.svg.axis().orient("bottom").ticks(d3.time.months,1).tickPadding(7).tickFormat(d3.time.format("%b")),p=d3.svg.axis().orient("left"),q=l.append("g").attr("class","axis").attr("transform","translate("+[0,k]+")"),r=l.append("g").attr("class","axis");r.append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Price ($)");var s=d3.svg.line().x(function(a){return m(a.date)}).y(function(a){return n(a.close)}),t=l.append("rect").attr("class","mousetarget").attr("width",j).attr("height",k).attr("fill","none").attr("pointer-events","all"),u=l.append("g").attr("class","linechart-tooltip").style("visibility","hidden"),v=130,w=40;u.append("line"),u.append("circle").attr("r",3).attr("class","inner-circle").attr("pointer-events","none"),u.append("circle").attr("r",10).attr("class","outer-circle").attr("pointer-events","none"),u.append("rect").attr("width",v).attr("height",w).attr("pointer-events","none");u.append("text").attr("pointer-events","none");t.on("mousemove",d),l.on("mouseleave",function(){u.style("visibility","hidden")});var x=d3.bisector(function(a){return a.date}).left,y=d3.format(",.2f"),z=function(a){return"$"+y(a)};window.onresize=function(){a.$apply()},a.$watch(function(){return f.clientWidth},function(){c()}),a.$watch("data",function(a){if(0==a.length)return void l.selectAll("path").remove();var b=angular.copy(a);m.domain([b[0].date,b[b.length-1].date]),n.domain(d3.extent(b,function(a){return a.close})),o.scale(m),p.scale(n),q.call(o),r.call(p);var c=l.insert("path",":first-child").datum(b).attr("class","line").attr("d",s),d=c.node().getTotalLength();c.attr("stroke-dasharray",d+" "+d).attr("stroke-dashoffset",d).transition().duration(700).ease("linear").attr("stroke-dashoffset",0)},!0)};return{template:"<div></div>",restrict:"EA",replace:!0,scope:{data:"="},link:a}}),angular.module("d3AngularDemosApp").directive("donutchart",function(){var a=function(a,b){function c(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return o(b(a))}}function d(){i=e.clientWidth-f.right-f.left;var a=d3.select(e).select("svg");a.attr("width",i+f.left+f.right),a.select("g").attr("transform","translate("+[i/2+f.right,j/2+f.top]+")"),l=Math.min(i,j)/2,o=d3.svg.arc().outerRadius(l).innerRadius(.6*l);a.selectAll("path").transition().attrTween("d",c)}var e=b[0],f={top:20,right:20,bottom:20,left:20},g=e.clientWidth,h=e.clientHeight,i=g-f.right-f.left,j=h-f.top-f.bottom,k=d3.select(e).append("svg").attr("width",g).attr("height",h).append("g").attr("transform","translate("+[i/2+f.right,j/2+f.top]+")"),l=Math.min(i,j)/2,m=d3.scale.category20(),n=d3.layout.pie().sort(null),o=d3.svg.arc().outerRadius(l).innerRadius(.6*l);window.onresize=function(){a.$apply()},a.$watch(function(){return e.clientWidth},function(){d()}),a.$watch("data",function(a){var b=angular.copy(a),d=k.selectAll("path").data(n(b));d.enter().append("path").style("fill",function(a,b){return m(b)}).each(function(){this._current={startAngle:0,endAngle:0}}),d.transition().duration(1e3).attrTween("d",c)},!0)};return{template:"<div></div>",restrict:"EA",replace:!0,scope:{data:"="},link:a}}),angular.module("d3AngularDemosApp").directive("meanVis",function(){var a=function(a,b){function c(a,b){g.select(".mean-dot").transition().delay(700).ease("linear").attr("cx",h(a)).attr("fill","#45A1DE"),g.select(".title").text("Visualizing the mean (n = "+b+", µ = "+d3.format(".2f")(a)+")")}var d=b[0],e=d.clientWidth,f=d.clientHeight,g=d3.select(d).append("svg").attr("width",e).attr("height",f),h=d3.scale.linear().domain([0,100]).range([0,e]);window.onresize=function(){a.$apply()};var i;a.resize=function(){var b=d.clientWidth;g.selectAll("circle").remove().transition().duration(0),g.select("line").remove(),g.selectAll("text").remove(),i&&clearTimeout(i),i=setTimeout(function(){b=d.clientWidth,g.selectAll("circle").remove(),g.attr("width",b),a.render(b),clearTimeout(i)},500)},a.render=function(a){var b=d3.range(150).map(function(){return Math.round(100*Math.random())});h.range([0,a]);{var d=Math.round(f/2);g.append("line").attr("x1",0).attr("y1",d).attr("x2",h(100)).attr("y2",d).attr("fill","none").attr("stroke","#707070").attr("stroke-width",2),g.append("text").attr("class","title").attr("x",h(50)).attr("y",f-20).attr("text-anchor","middle").text("Visualizing the mean (n = 0, µ = 0)")}g.append("text").attr("x",h(1)).attr("y",d+20).attr("text-anchor","start").text("0"),g.append("text").attr("x",h(99)).attr("y",d+20).attr("text-anchor","end").text("100");var e=[],i=g.selectAll("circle").data(b).enter().append("circle").attr("cx",function(a){return h(a)}).attr("cy",0).attr("r",4).attr("fill","none");i.transition().delay(function(a,b){return 100*b}).duration(2500).ease("bounce").each("start",function(a){e.push(a);var b=d3.mean(e);c(b,e.length)}).attr("cx",function(a){return h(a)}).attr("cy",d).attr("fill","#fff");g.append("circle").attr("class","mean-dot").attr("cy",d).attr("r",15).attr("fill","none")},a.$watch(function(){return d.clientWidth},function(){a.resize()}),a.$watch("replayCount",function(b){b>1&&a.resize()})};return{template:"<div></div>",restrict:"EA",replace:!0,scope:{replayCount:"="},link:a}}),angular.module("d3AngularDemosApp").factory("DataSvc",["$http","$q",function(a,b){var c={};return c.getTopRepos=function(){return a.get("data/github-repos-2013.json").then(function(a){return a.data})},c.getStockData=function(){var a=b.defer(),c=d3.time.format("%d-%b-%y").parse;return d3.csv("data/aapl.csv",function(b,d){d.forEach(function(a){a.date=c(a.date),a.close=+a.close}),d.sort(function(a,b){return a.date-b.date}),a.resolve(d)}),a.promise},c.getRandomPieData=function(){var a=d3.range(7).map(function(){return Math.round(100*Math.random())});return a},c}]);